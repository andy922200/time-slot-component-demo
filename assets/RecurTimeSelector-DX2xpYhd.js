import{d as J,r as $,c as M,J as V,b as d,F as g,f as E,i as n,e as o,t as b,y as K,x as q,C as Q,w as O,g as j,n as C,a as v,o as X,h as z,k as Z}from"./index-BN4XCwYM.js";import{_ as F}from"./index.vue_vue_type_script_setup_true_lang-CH1qjNL0.js";import{g as ee,b as te,c as le}from"./utils-gsKGVBIS.js";import{i as U}from"./time-selector-D1VBJ9xa.js";import"./index-CSaXsr8O.js";const N={en:[{full:"Sunday",abbr:"Sun"},{full:"Monday",abbr:"Mon"},{full:"Tuesday",abbr:"Tue"},{full:"Wednesday",abbr:"Wed"},{full:"Thursday",abbr:"Thu"},{full:"Friday",abbr:"Fri"},{full:"Saturday",abbr:"Sat"}],zh_tw:[{full:"星期日",abbr:"日"},{full:"星期一",abbr:"一"},{full:"星期二",abbr:"二"},{full:"星期三",abbr:"三"},{full:"星期四",abbr:"四"},{full:"星期五",abbr:"五"},{full:"星期六",abbr:"六"}],zh_cn:[{full:"星期日",abbr:"日"},{full:"星期一",abbr:"一"},{full:"星期二",abbr:"二"},{full:"星期三",abbr:"三"},{full:"星期四",abbr:"四"},{full:"星期五",abbr:"五"},{full:"星期六",abbr:"六"}]},ae={class:"recur-time-selector flex flex-wrap"},se={class:"label__wrapper mb-2 mr-2 w-full lg:mb-0 lg:w-auto"},ne=["for"],re={key:0,class:"inline-block w-20 text-center"},de=["id","onUpdate:modelValue","disabled"],oe=["value","disabled"],ie=["id","onUpdate:modelValue","disabled"],ce=["value","disabled"],ue=J({name:"RecurTimeSelector",__name:"index",props:{closeAllSelector:{type:Boolean,default:!1},weekStartDay:{default:0},timeSlotDuration:{default:30},disabledDays:{default:()=>[]},locale:{default:"zh_tw"},isAbbrText:{type:Boolean,default:!1},selectClass:{default:"w-full truncate rounded border border-[#ccc] py-2 pl-2 pr-8 focus:border-blue-300 focus:ring-blue-300 min-w-32"},optionClass:{default:""}},emits:["change"],setup(T,{emit:y}){const r=T,w=y,D=$([]),h=M(()=>{const s=r.weekStartDay;return[...D.value.slice(s),...D.value.slice(0,s)]}),S=()=>{D.value=Array.from({length:7},(s,l)=>{var i,a;const t=r.disabledDays.includes(l);return{selectedStartTime:"",selectedEndTime:"",value:l.toString(),text:r.isAbbrText?(i=N[r.locale])==null?void 0:i[l].abbr:(a=N[r.locale])==null?void 0:a[l].full,isToggle:!1,isDisableDay:t,startTimeOptions:t?[]:[{start:"",end:"",weekday:""},...ee({timeSlotDuration:r.timeSlotDuration,weekday:l.toString()})],endTimeOptions:t?[]:[{start:"",end:"",weekday:""}]}})},m=()=>{h.value.forEach(s=>{V(()=>s.selectedStartTime,()=>{s.selectedEndTime="",s.endTimeOptions=[{start:"",end:"",weekday:""},...s.startTimeOptions.filter(l=>s.selectedStartTime?l.start>=s.selectedStartTime:!1)]},{deep:!0})})};return V(()=>r.disabledDays,()=>{S(),m()},{deep:!0,immediate:!0}),V(()=>h.value,s=>{const l=s.filter(t=>t.isToggle).map(t=>({selectedStartTime:t.selectedStartTime,selectedEndTime:t.selectedEndTime,weekday:t.value,text:t.text,isValid:!!t.selectedStartTime&&!!t.selectedEndTime}));w("change",l)},{deep:!0}),(s,l)=>(n(),d("div",ae,[(n(!0),d(g,null,E(h.value,(t,i)=>(n(),d("div",{key:i,class:"my-4 flex w-full flex-wrap items-center px-4 lg:my-2 lg:justify-center lg:px-0"},[o("div",se,[o("label",{for:`toggle-${i}`,class:"mx-2"},b(t.text),9,ne),t.isDisableDay?(n(),d("span",re,[K(s.$slots,"disable-day-text",{},()=>[l[0]||(l[0]=q("無適用時段"))])])):(n(),Q(F,{key:1,id:`toggle-${i}`,value:t.isToggle,"onUpdate:value":a=>t.isToggle=a,disabled:s.closeAllSelector,class:"w-20","switch-on-color":"#3A7DC9"},null,8,["id","value","onUpdate:value","disabled"]))]),o("div",{class:C(["start-options__wrapper w-1/2 px-2 lg:w-auto",{hidden:!t.isToggle}])},[O(o("select",{id:`start-${i}`,"onUpdate:modelValue":a=>t.selectedStartTime=a,disabled:!t.isToggle||s.closeAllSelector,class:C([r.selectClass,t.selectedStartTime.length===0?"border-red-500":""])},[(n(!0),d(g,null,E(t.startTimeOptions,(a,p)=>(n(),d("option",{key:`start-${i}-${p}`,value:a.start,class:C([r.optionClass]),disabled:a.start===""},b(a.start===""?s.$t("please-select-start-time"):a.start),11,oe))),128))],10,de),[[j,t.selectedStartTime]])],2),o("div",{class:C(["end-options__wrapper w-1/2 pl-2 lg:w-auto",{hidden:!t.isToggle}])},[O(o("select",{id:`end-${i}`,"onUpdate:modelValue":a=>t.selectedEndTime=a,disabled:!t.isToggle||s.closeAllSelector,class:C([r.selectClass,t.selectedEndTime.length===0?"border-red-500":""])},[(n(!0),d(g,null,E(t.endTimeOptions,(a,p)=>(n(),d("option",{key:`end-${i}-${p}`,value:a.end,class:C([r.optionClass]),disabled:a.end===""},b(a.end===""?s.$t("please-select-end-time"):a.end),11,ce))),128))],10,ie),[[j,t.selectedEndTime]])],2)]))),128))]))}}),fe=async({selectedStartDate:T,selectedEndDate:y,dateFormatStr:r="YYYY-MM-DD",selectedRecurTimeResult:w=[],usedTimeSlots:D=[]})=>{const h=v(T,r),S=v(y,r),m=[];let s=!1;for(let l=h;l.isSameOrBefore(S);l=l.add(1,"day")){const t=l.day(),i=v().startOf("day"),a=w.find(_=>parseInt(_.weekday)===t),p=D.filter(_=>{const x=v(_.date).format(r);return l.isSame(i)&&v(`${_.date} ${_.endTime}`,`${r} HH:mm`).isBefore(v())?!1:x===l.format(r)});if(a&&p.length>0){if(v(`${l.format(r)} ${a.selectedStartTime}`,`${r} HH:mm`).isBefore(v())){s=!0;break}const _={...a,conflictDate:l.format(r),usedSlot:p,conflictSlot:[],startOptions:[],endOptions:[],endOptionsRaw:{},finalSelectedStartTime:"",finalSelectedEndTime:""};p.forEach(x=>{U({startTime:a.selectedStartTime,endTime:a.selectedEndTime,date:l.format(r),slotStart:x.startTime,slotEnd:x.endTime,slotDate:x.date})&&_.conflictSlot.push(x)}),_.conflictSlot.length>0&&m.push(_)}}return{hasConflict:m.length>0,conflictList:m,allInPast:s}},me=({conflictItem:T,timeSlotDuration:y=30,dateFormat:r="YYYY-MM-DD"})=>{let w=[];const D={},h=v(),S=v(T.conflictDate).format(r)===h.format(r);let m=v(`${T.conflictDate} 00:00`,`${r} HH:mm`);const s=v(`${T.conflictDate} 24:00`,`${r} HH:mm`);for(;m.isBefore(s);)T.usedSlot.some(t=>U({startTime:m.format("HH:mm"),endTime:m.add(y,"minute").format("HH:mm"),date:T.conflictDate,slotStart:t.startTime,slotEnd:t.endTime,slotDate:t.date}))||w.push({date:T.conflictDate,label:m.format("HH:mm"),value:m.format("HH:mm")}),m=m.add(y,"minute");return S&&(w=w.filter(l=>v(`${l.date} ${l.value}`,`${r} HH:mm`).isSameOrAfter(h,"minute"))),w.forEach(l=>{let t=v(`${T.conflictDate} ${l.value}`,`${r} HH:mm`).add(y,"minute");const i=[];for(;t.isSameOrBefore(s);)T.usedSlot.some(p=>U({startTime:l.value,endTime:t.format("HH:mm"),date:T.conflictDate,slotStart:p.startTime,slotEnd:p.endTime,slotDate:p.date}))||i.push({date:T.conflictDate,label:t.format("HH:mm")==="00:00"?"24:00":t.format("HH:mm"),value:t.format("HH:mm")}),t=t.add(y,"minute");D[l.value]=i.length>0?[{label:"結束",disabled:!0,value:"",date:""},...i]:[]}),w.unshift({label:"開始",disabled:!0,value:"",date:""},{label:"不預約",value:"no-booked",date:""}),{availableStartTimes:w,availableEndTimes:D}},pe={class:"mx-auto w-full"},be={class:"flex items-center justify-center"},ye={class:"m-2"},ve={class:"my-1 flex flex-wrap justify-center"},Te={class:"my-1 flex flex-wrap justify-center"},he={class:"mb-2 w-full text-center"},ge={class:"mb-2 w-full text-center"},we={class:"flex items-center justify-center"},Se={class:"m-2"},_e={class:"my-1 flex flex-wrap justify-center"},De=["disabled"],ke={class:"my-1 flex flex-wrap justify-center"},xe={key:0,class:"w-full text-center"},$e={key:0,class:"w-full text-center"},Ee={key:1,class:"w-full text-center"},He=["onUpdate:modelValue"],Ce=["value","disabled"],Re=["onUpdate:modelValue"],Oe=["value","disabled"],Ve={key:0,class:"w-full text-center"},je={key:1,class:"w-full text-center"},Ae={key:2,class:"w-full text-center"},H="YYYY-MM-DD",P=30,Le=J({__name:"RecurTimeSelector",setup(T){const y=v(),r=y.subtract(1,"day"),w=y.add(1,"day"),D=y.add(1,"month"),h=$(!1),S=$([]),m=$(!1),s=$(""),l=$([]),t=async()=>{await new Promise(e=>setTimeout(e,500));const c=[],f=e=>{const u=c.filter(A=>A.date===e.format(H)),{start:k,end:R}=te(u);c.push({date:e.format(H),start:k,end:R,type:"used"})};f(r);for(let e=0;e<2;e++)f(y);for(let e=0;e<2;e++)f(w);for(let e=0;e<3;e++)f(D);return c.map(e=>({startTime:e.start,endTime:e.end,date:e.date})).sort((e,u)=>{const k=e.date,R=u.date;return k!==R?k.localeCompare(R):e.startTime.localeCompare(u.startTime)})},i=$(y.format(H)),a=$(y.format(H)),p=$([]),_=M(()=>p.value.every(c=>c.isValid)),x=M(()=>{var c;return((c=le({startDate:i.value,endDate:a.value}))==null?void 0:c.exclude)||[]}),B=c=>{p.value=c},Y=()=>{h.value=!1,m.value=!1,s.value="",L()},W=()=>{h.value=!1,m.value=!1,s.value="",L()},L=()=>{S.value=[]},G=async()=>{if(h.value=!1,p.value.length===0)return alert("請檢查是否有選擇內容");if(!p.value.every(u=>u.isValid===!0))return alert("請檢查內容是否有誤");if(v(i.value,H).isBefore(y,"day"))return alert("開始日期不可早於今天");const{allInPast:f,conflictList:e}=await fe({selectedStartDate:i.value,selectedEndDate:a.value,selectedRecurTimeResult:p.value,usedTimeSlots:l.value,dateFormatStr:H});if(f){s.value="開始時間有包含過去的時間段",m.value=!0;return}else s.value="";for(let u=0;u<e.length;u++){const k=e[u],{availableStartTimes:R,availableEndTimes:A}=me({conflictItem:k,timeSlotDuration:P,dateFormat:H});e[u].startOptions=R,e[u].endOptionsRaw=A}S.value=e,I(),h.value=!0,m.value=!0},I=()=>{S.value.forEach(c=>{V(()=>c.finalSelectedStartTime,f=>{c.finalSelectedEndTime="",c.endOptions=c.endOptionsRaw[f]||[]},{deep:!0})})};return X(async()=>{const c=await t();l.value=c}),V(i,c=>{c&&Y()}),V(a,c=>{c&&W()}),(c,f)=>(n(),d("div",pe,[o("div",be,[o("h3",ye,b(c.$t("used-time-slots")),1),o("ul",null,[(n(!0),d(g,null,E(l.value,e=>(n(),d("li",{key:e.startTime},[o("p",null,b(e.date)+" "+b(e.startTime)+" ~ "+b(e.endTime),1)]))),128))])]),o("div",ve,[f[2]||(f[2]=o("p",{class:"mb-2 w-full text-center"},"選取的週期時間",-1)),(n(!0),d(g,null,E(p.value,e=>(n(),d("p",{key:e.weekday,class:C(["mb-2 w-full text-center",{"text-red-500":!e.isValid}])},b(e.weekday)+": "+b(e.selectedStartTime)+" ~ "+b(e.selectedEndTime),3))),128))]),o("div",Te,[o("p",he,"限制選取日: "+b(x.value),1),f[3]||(f[3]=o("p",{class:"mb-2 w-full text-center"},"0: Sun, 1: Mon, ...etc.",-1)),o("p",ge,"選取內容無漏填: "+b(_.value),1)]),o("div",we,[o("div",Se,[f[4]||(f[4]=o("label",{for:"start-date-picker",class:"mx-2"},"開始日期",-1)),O(o("input",{id:"start-date-picker","onUpdate:modelValue":f[0]||(f[0]=e=>i.value=e),type:"date",onChange:Y},null,544),[[z,i.value]]),f[5]||(f[5]=o("label",{for:"end-date-picker",class:"mx-2"},"結束日期",-1)),O(o("input",{id:"end-date-picker","onUpdate:modelValue":f[1]||(f[1]=e=>a.value=e),type:"date",onChange:W},null,544),[[z,a.value]])])]),Z(ue,{"close-all-selector":i.value===""||a.value===""||h.value,"week-start-day":1,"disabled-days":x.value,"time-slot-duration":P,class:"flex justify-center",onChange:B},null,8,["close-all-selector","disabled-days"]),o("div",_e,[o("button",{class:"send-form rounded bg-black px-4 py-2 text-white",disabled:h.value,onClick:G}," 送出 ",8,De)]),o("div",ke,[!m.value&&(i.value===""||a.value==="")?(n(),d("p",xe,"無檢查結果")):(n(),d(g,{key:1},[m.value?(n(),d(g,{key:0},[S.value.length===0?(n(),d(g,{key:0},[s.value?(n(),d("p",Ee,b(s.value),1)):(n(),d("p",$e,"無衝突，可打 api"))],64)):(n(),d(g,{key:1},[f[6]||(f[6]=o("p",{class:"w-full text-center"},"有衝突，請檢查以下選項",-1)),(n(!0),d(g,null,E(S.value,e=>(n(),d("p",{key:e.weekday,class:"mb-2 w-full text-center"},[q(b(e.conflictDate)+" - "+b(e.weekday)+": "+b(e.selectedStartTime)+" ~ "+b(e.selectedEndTime)+" ",1),O(o("select",{"onUpdate:modelValue":u=>e.finalSelectedStartTime=u},[(n(!0),d(g,null,E(e.startOptions,(u,k)=>(n(),d("option",{key:`start-${e.weekday}-${k}`,value:u.value,disabled:u.disabled},b(u.label),9,Ce))),128))],8,He),[[j,e.finalSelectedStartTime]]),O(o("select",{"onUpdate:modelValue":u=>e.finalSelectedEndTime=u},[(n(!0),d(g,null,E(e.endOptions,(u,k)=>(n(),d("option",{key:`end-${e.weekday}-${k}`,value:u.value,disabled:u.disabled},b(u.label),9,Oe))),128))],8,Re),[[j,e.finalSelectedEndTime]])]))),128))],64))],64)):(n(),d(g,{key:1},[p.value.length===0?(n(),d("p",Ve,"尚無選擇結果")):p.value.some(e=>e.isValid===!1)?(n(),d("p",je," 請檢查選取內容是否都已選取 ")):(n(),d("p",Ae,"請點選「送出」來檢查"))],64))],64))])]))}});export{Le as default};
